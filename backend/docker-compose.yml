services:
  mongo:
    image: mongo:7
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-example}
    volumes:
      - mongo_data:/data/db

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
    depends_on:
      mongo:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9050/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    environment:
      PORT: ${PORT:-9050}
      MONGO_HOST: mongo
      MONGO_PORT: 27017
      MONGO_DB: ${MONGO_DB:-maimai_web}
      MONGO_USER: ${MONGO_USER:-root}
      MONGO_PASSWORD: ${MONGO_PASSWORD:-example}
      MONGO_AUTH_SOURCE: ${MONGO_AUTH_SOURCE:-admin}
      MUSIC_DATA_URL: ${MUSIC_DATA_URL:-https://www.diving-fish.com/api/maimaidxprober/music_data}
      MUSIC_SYNC_CRON: ${MUSIC_SYNC_CRON:-0 */6 * * *}
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET:-change-me-in-production}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}
    volumes:
      - ./covers:/app/covers

  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./covers:/covers:ro

volumes:
  mongo_data:
