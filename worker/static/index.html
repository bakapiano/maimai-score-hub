<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maimai Cookie Manager</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ccc; border-radius: 4px; }
        pre { background: #f4f4f4; padding: 1rem; overflow-x: auto; }
        .row { margin-bottom: 1rem; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-healthy { background-color: #4caf50; }
        .status-unhealthy { background-color: #f44336; }
        .status-checking { background-color: #ff9800; }
        .status-row { margin: 0.5rem 0; }
    </style>
    <script>
        let statusCheckInterval;
        let cookieCheckInterval;
        const healthRetryDelay = 2000;
        let backendHealthy = false;
        let proxyConfigured = false;

        const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

        async function checkBackendHealth() {
            try {
                const response = await fetch('/api/health', { 
                    cache: 'no-store'
                });
                backendHealthy = response.ok;
                
                const indicator = document.getElementById('backendHealthIndicator');
                const status = document.getElementById('backendHealthStatus');
                
                if (backendHealthy) {
                    indicator.className = 'status-indicator status-healthy';
                    status.innerText = 'Healthy - Worker service running';
                } else {
                    indicator.className = 'status-indicator status-unhealthy';
                    status.innerText = `Unhealthy - Status ${response.status}`;
                }
            } catch (err) {
                backendHealthy = false;
                document.getElementById('backendHealthIndicator').className = 'status-indicator status-unhealthy';
                document.getElementById('backendHealthStatus').innerText = 'Error: ' + err.message;
            }
        }

        async function checkProxyConfiguration() {
            try {
                const response = await fetch('http://93.184.215.14', { cache: 'no-store' });
                const data = await response.json().catch(() => ({}));
                proxyConfigured = data.success === true;
                
                const indicator = document.getElementById('proxyConfigIndicator');
                const status = document.getElementById('proxyConfigStatus');
                
                if (proxyConfigured) {
                    indicator.className = 'status-indicator status-healthy';
                    status.innerText = `Configured - ${data.message || 'Working'}`;
                } else {
                    indicator.className = 'status-indicator status-unhealthy';
                    status.innerText = 'Not configured - No response from proxy';
                }
            } catch (err) {
                proxyConfigured = false;
                document.getElementById('proxyConfigIndicator').className = 'status-indicator status-unhealthy';
                document.getElementById('proxyConfigStatus').innerText = 'Error: ' + err.message;
            }
        }

        async function checkCookieStatus() {
            try {
                const response = await fetch('/api/status', { cache: 'no-store' });
                const data = await response.json();
                
                const indicator = document.getElementById('cookieStatusIndicator');
                const status = document.getElementById('cookieStatusText');

                if (data.authOngoing) {
                    indicator.className = 'status-indicator status-checking';
                    status.innerText = 'Auth in progress...';
                } else if (data.expired) {
                    indicator.className = 'status-indicator status-unhealthy';
                    status.innerText = data.friendCode
                        ? `Expired - Bot ${data.friendCode}`
                        : 'No bot cookie found';
                    // Auto-start auth when cookie is expired and system is ready
                    if (backendHealthy && proxyConfigured) {
                        startAuth();
                    }
                } else {
                    indicator.className = 'status-indicator status-healthy';
                    status.innerText = `Valid - Bot ${data.friendCode}`;
                }
            } catch (err) {
                document.getElementById('cookieStatusIndicator').className = 'status-indicator status-unhealthy';
                document.getElementById('cookieStatusText').innerText = 'Error: ' + err.message;
            }
        }

        async function checkSystemStatus() {
            await Promise.all([checkBackendHealth(), checkProxyConfiguration(), checkCookieStatus()]);
        }

        function startStatusChecking() {
            checkSystemStatus();
            if (!statusCheckInterval) {
                statusCheckInterval = setInterval(checkSystemStatus, 5_000);
            }
        }

        async function waitForHealth(timeout = 30000) {
            const deadline = Date.now() + timeout;
            while (Date.now() < deadline) {
                try {
                    const res = await fetch('/api/health', { cache: 'no-store' });
                    if (res.ok) {
                        const data = await res.json().catch(() => ({}));
                        if (!data.status || data.status === 'ok') {
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('Health check failed, retrying...', err);
                }
                document.getElementById('status').innerText = "Waiting for service to be ready...";
                await sleep(healthRetryDelay);
            }
            throw new Error('Health check timed out');
        }

        async function startAuth() {
            if (!backendHealthy || !proxyConfigured) {
                document.getElementById('status').innerText = "Cannot start auth: Backend or proxy not ready";
                return;
            }

            try {
                await waitForHealth();
                const response = await fetch('/api/auth');
                const data = await response.json();
                if (data.authUrl) {
                    window.location.href = data.authUrl;
                } else {
                    alert("Failed to get auth URL");
                }
            } catch (e) {
                console.error(e);
                alert("Error starting auth");
            }
        }

        window.onload = () => {
            startStatusChecking();
        };
    </script>
</head>
<body>
    <h1>Maimai Cookie Manager</h1>
    
    <div class="section">
        <h2>System Status</h2>
        <div class="status-row">
            <span class="status-indicator status-checking" id="backendHealthIndicator"></span>
            <strong>Backend Health:</strong> <span id="backendHealthStatus">Checking...</span>
        </div>
        <div class="status-row">
            <span class="status-indicator status-checking" id="proxyConfigIndicator"></span>
            <strong>Proxy Configuration:</strong> <span id="proxyConfigStatus">Checking...</span>
        </div>
        <div class="status-row">
            <span class="status-indicator status-checking" id="cookieStatusIndicator"></span>
            <strong>Bot Cookie:</strong> <span id="cookieStatusText">Checking...</span>
        </div>
    </div>
    
    <div class="section">
        <h2>Auth</h2>
        <div id="status">Checking status...</div>
        <div style="margin-top: 1rem;">
            <button onclick="startAuth()">Start Auth (Login)</button>
        </div>
    </div>
</body>
</html>